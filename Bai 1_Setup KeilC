BÃ i 01: Introduction and Environment Setup
ğŸ”° Introduction to STM32 and Microcontrollers
ğŸ”° Setting up the Development Environment and Necessary Tools
ğŸ”° Programming using registers

Khi vÃ o uVision. Giao diá»‡n trong má»¥c project cÃ³ 4 tab: Project (viáº¿t code), Book (TÃ i liá»‡u vdk), Function (cÃ¡c hÃ m cho lÃ¢p trÃ¬nh), 
 
Trong Debug chá»n ST-Link Debbuger (usb náº¡p code cho stm32)
 
LÆ°u Ã½ khi káº¿t ná»‘i vá»›i ST-Link náº¿u trong má»¥c Serial Number hiá»‡n ra Serial cá»§a ST link lÃ  káº¿t ná»‘i thÃ nh cÃ´ng. Trong má»¥c SWDIO tháº¥y hiá»‡n dÃ²ng mÃ£ chÆ°Æ¡ng trÃ¬nh nÃ o Ä‘Ã³ lÃ  káº¿t ná»‘i thÃ nh cÃ´ng Ä‘áº¿n vi Ä‘iá»u khiá»ƒn.
 
 
Arm Complier chon Version 5 cho Ä‘á»¡ lá»—i, náº¿u ver cao hÆ¡n 6, 7 cÅ©ng chuyá»ƒn vá» 5.
 
â€ƒ
SÆ¡ Ä‘á»“ khá»‘i cá»§a vi Ä‘iá»u khiá»ƒn stm32
 
Äá»ƒ lÃ m viá»‡c vá»›i má»™t pháº§n cá»©ng cáº§n 3 bÆ°á»›c:
-	Cáº¥p xung clock cho ngoáº¡i vi 
-	Cáº¥u hÃ¬nh chÃ¢n cho ngoáº¡i vi
-	Sá»­ dá»¥ng ngoáº¡i vi
Vi Ä‘iá»u khiá»ƒn sáº½ cáº¥p xung nhá»‹p cho ngoáº¡i vi Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng. khi gáº·p cáº¡nh lÃªn hoáº·c cáº¡nh xuá»‘ng xung nhá»‹p nÃ³ sáº½ thá»±c hiá»‡n 1 cÃ´ng viá»‡c nÃ o Ä‘Ã³. KhÃ´ng cáº¥p clock ngoáº¡i vi sáº½ khÃ´ng hoáº¡t Ä‘á»™ng.
Äá»ƒ cáº¥p clock cho ngoáº¡i vi pháº£i lÃ m viá»‡c vá»›i thanh ghi RCC
 
Cáº¥p clock tá»« RCC=> Bus => Ngoáº¡i vi=> chÃ¢n ngoáº¡i vi
Ngoáº¡i vi cÃ³ 3 Ä‘Æ°á»ng bus: Bus há»‡ thá»‘ng AHB, 2 Ä‘Æ°á»ng bus Ä‘áº¿n ngoáº¡i vi lÃ  APB1, APB2.
VÃ­ dá»¥ Ä‘á»ƒ nhÃ¡y Led PC13 : P: Pin, C: Port C, 13 : chÃ¢n thá»© 13 trong Port C (0â€¦15)
 
Cáº¥p clock qua thanh ghi RCC_ABP2ENR

 
CÃ¡c cáº¥p clock ghi bit tÆ°Æ¡ng á»©ng cá»§a ngoáº¡i vi Ä‘Ã³ lÃªn 1. Muá»‘n disable ngoáº¡i vi chá»‰ cáº§n ghi 0 vÃ o.

Má»—i pháº§n cá»©ng trÃªn thiáº¿t bá»‹ Ä‘á»u Ä‘Æ°á»£c Ä‘iá»u khiá»ƒn báº±ng thanh ghi tÆ°Æ¡ng á»©ng. STM32 cÃ³ khoáº£ng 23-25 thanh ghi khÃ¡c nhau.
Má»—i ngoáº¡i vi Ä‘Æ°á»£c cáº¥p phÃ¡t má»™t vÃ¹ng nhá»› vá»›i dáº£i Ä‘á»‹a chá»‹ tÆ°Æ¡ng á»©ng. nÃªn trÆ°á»›c khi lÃ m viá»‡c vs ngoáº¡i vi cáº§n xem nÃ³ náº±m á»Ÿ khu nhá»› nÃ o
BÆ°á»›c tháº¥p nháº¥t cá»§a láº­p trÃ¬nh lÃ  viáº¿t tháº³ng giÃ¡ trá»‹ vÃ o thanh ghi
VÃ­ dá»¥ muá»‘n lÃ m viá»‡c thanh ghi PortA GPIOx_CRH 
Address offset: 0x04 : Äá»™ dá»i Ä‘á»‹a chá»‰ cá»§a thanh ghi so má»›i Äá»‹a chá»‰ gá»‘c cá»§a ngoáº¡i vi GPIO.
Äá»‹a chá»‰ gá»‘c GPIO Port A : 0x 4001 0800 + offset 0x04 = 0x 4001 0804 : ÄÃ¢y chÃ­nh lÃ  Ä‘á»‹a chá»‰ thanh ghi CRH cá»§a Port A. 
Reset value: 0x4444 4444 : GiÃ¡ trá»‹ sau khi reset thanh ghi
 
Äá»ƒ nhÃ¬n nhanh Offset cá»§a tá»«ng loáº¡i thanh ghi vÃ o Register map cá»§a ngoáº¡i vi Ä‘Ã³.
 
CÃ¡ch láº¥y giÃ¡ trá»‹ trong thanh ghi vÃ  vÃ¹ng nhá»›:
-	Láº¥y Ä‘á»‹a chá»‰ thanh ghi hay vÃ¹ng nhá»› (VD: 0x4002 1018).
-	 Ã‰p kiá»ƒu cho nÃ³ thÃ nh kiá»ƒu con trá» (VD: usigned int*)
-	Sau Ä‘Ã³ dÃ¹ng phÃ©p toÃ¡n dereference * Ä‘á»ƒ láº¥y giÃ¡ trá»‹ cá»§a nÃ³. 
VÃ­ dá»¥: #define RCC_APB2ENR *(usigned int*) 0x4002 1018.
Int lÃ  kiá»ƒu sá»‘ 32 bit
Äá»ƒ ghi giÃ¡ trá»‹ vÃ o thanh ghi mÃ  khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c bit Ä‘á»‹a chá»‰ khÃ¡c dÃ¹ng ká»¹ thuáº­t bitmask. Táº¡o máº·t náº¡ bitmask vÃ  DÃ¹ng phÃ©p toÃ¡n OR: a |=b, a = a|b.
VÃ­ dá»¥ : Äá»ƒ cáº¥p clock cho Port C (IOPC). nÃ³ lÃ  bit sá»‘ 4
NhÆ° báº£ng bÃªn dÆ°á»›i, a lÃ  giÃ¡ trá»‹ ban Ä‘áº§u thanh ghi, b lÃ  bitmask : (1<<4): Sá»‘ 1 dá»‹ch trÃ¡i 4 láº§n
RCC_APB2ENR |= (1<<4); ( cáº¥p clock cho gpio C thÃ nh cÃ´ng).
 
BÆ°á»›c 2: Cáº¥u HÃ¬nh ChÃ¢n cho ngoáº¡i Vi.
B1: Cáº¥p clock cho chÃ¢n PC13.
GPIO.C cÃ³ 16 chÃ¢n. DÃ¹ng 2 thanh ghi GPIOx_CRL (Äiá»u khiá»ƒn chÃ¢n 0-7) vÃ  GPIOx_CRH (chÃ¢n 8-15). ChÃ¢n PC13 lÃ  chÃ¢n thá»© 13 nÃªn dÃ¹ng thanh ghi GPIOx_CRH Ä‘iá»u khiá»ƒn. cÅ©ng dÃ¹ng ká»¹ thuáº­t bitmask Ä‘á»ƒ Ä‘á»•i giÃ¡ trá»‹ 0-1 cho nÃ³.
 
#define GPIOx_CRH *(unsigned int*) 0x4001 1004
GPIOx_CRH |= (1<<13);
B2. Cáº¥u hÃ¬nh cháº¿ Ä‘á»™ hoáº¡t Ä‘á»™ng cho chÃ¢n (Configuraton).
 
1.Mode [1:0]: Cáº¥u hÃ¬nh cháº¿ Ä‘á»™ input hay output (ghi tÃ­n hiá»‡u Ä‘iá»‡n Ã¡p ra). Output (cÃ³ 3 lá»±a chá»n tá»‘c Ä‘á»™  maxspeed 10MHz, 2MHz, 50 MHz).
2.CNFy[1:0]: Cáº·p bÃ­t nÃ y quyáº¿t Ä‘á»‹nh Ä‘á»c tÃ­n hiá»‡u input, output thÃ¬ Ä‘á»c theo kiá»ƒu nÃ o. Má»—i mode cÃ³ 4 kiá»ƒu Ä‘á»c ghi.
Input (Mode[1:0]=00): chá»n kiá»ƒu:
00: Äá»c ra tÃ­n hiá»‡u tÆ°Æ¡ng tá»±-analog, 
01: Äá»c tÃ­n hiá»‡u Ä‘iá»‡n Ã¡p thÃ´ng thÆ°á»ng Floating input- má»©c Ä‘iá»‡n Ã¡p lÆ¡ lá»­ng, 
10: Äiá»‡n trá»Ÿ kÃ©o chÃ¢n lÃªn Vcc (pull up)/hoáº·c kÃ©o tÃ­n hiá»‡u xuá»‘ng GND (pull down). GiÃºp chÃ¢n cÃ³ má»©c Ä‘iá»‡n Ã¡p á»•n Ä‘á»‹nh.
Output (Mode[1:0] = 01,10, or 11):
General Purpose : Kiá»ƒu Ä‘a dá»¥ng lÃ m gÃ¬ cÅ©ng Ä‘Æ°á»£c.
Alternate Function: Kiá»ƒu thay tháº¿ (truyá»n dá»¯ liá»‡u, xá»­ lÃ½ tÃ­n hiá»‡u nÃ o Ä‘Ã³ trong bá»™ bá»™ UART, I2C, SPI)
Push Pull : giÃºp táº¡i má»™t thá»i Ä‘iá»ƒm luÃ´n cÃ³ 1 má»©c Ä‘iá»‡n Ã¡p cá»‘ Ä‘á»‹nh (=0 hoáº·c =1)
Open Drain: Náº¿u chÃ¢n báº¡n Ä‘iá»u khiá»ƒn thÃ¬ nÃ³ háº¡ xuá»‘ng má»©c 0, khÃ´ng Ä‘iá»u khiá»ƒn thÃ¬ nÃ³ sáº½ lÆ¡ lá»­ng khÃ´ng cÃ³ má»©c Ä‘iá»‡n Ã¡p cá»‘ Ä‘á»‹nh)
Äá»ƒ Ä‘iá»u khiá»ƒn Led PC13: 
ChÃº Ã½ Anode cá»§a nÃ³ ná»‘i lÃªn VCC3 (3V), Cathode ná»‘i vÃ o PC13. Muá»‘n nÃ³ sÃ¡ng háº¡ PC13 vá» 0 (0V), Táº¯t thÃ¬ Ä‘áº©y PC13 lÃªn 1 (3V). NhÆ° váº­y PC13 pháº£i lÃ  1 chÃ¢n ghi tÃ­n hiá»‡u Ä‘iá»‡n Ã¡p ra output.
 
Cáº¥u hÃ¬nh cho chÃ¢n nÃ y ta sá»­ dá»¥ng Thanh ghi GPIO_CRH. Cáº¥u hÃ¬nh trÃªn Mode 13 & CNF 13.
Mode : 11, CNF: 00.  Nhiá»‡m vá»¥ ghi vÃ o bit 23, 22, 21. 20 cÃ¡c bit 0011 = 3. PhÃ©p dá»‹ch bit sá»‘ 1 lÃºc  Ä‘áº§u sáº½ náº±m vá»‹ trÃ­ bit O.bitmask=( 3<<20) cÃ¡c bit sáº½ vÃ o vá»‹ trÃ­ nhÆ° trÃªn.
GPIO_CRH |= (3<<20).

CÃ¡c lÃ m Ä‘Æ¡n láº» cho bit 00 á»Ÿ vá»‹ trÃ­ 23, 22.
CÅ©ng dá»‹ch bit 1 vÃ o 2 vá»‹ trÃ­ trÃªn. Xong dÃ¹ng phÃ©p Ä‘áº£o bit 1=>0. Thá»±c hiá»‡n phÃ©p AND & Ä‘á»ƒ biáº¿n háº¿t cÃ¡c bit á»Ÿ Ã´ 23, 22 vá» 0.
GPIO_CRH &= ~ ((1<<23)|(1<<22))
~ : phÃ©p Ä‘áº£o bit, & lÃ  AND, = : gÃ¡n báº±ng
 
BÆ°á»›c 3: ÄÆ°a tÃ­n hiá»‡u ra chÃ¢n PC13. DÃ¹ng thanh ghi ODR.
#define GPIO_ODR *(unsigned int*) 0x4001 100C
GPIO_ODR |= (1<<13);
Delay (1.000.000);
GPIO_ODR &= ~(1<<13); \\ Äáº£o bit 1 thÃ nh 0 vÃ  dÃ¹ng phÃ©p &
Delay (1.000.000);
 
ÄÄƒt Break Point,
Nhá»¯ng chá»— xÃ¡m xÃ¡m cÃ³ thá»ƒ Ä‘áº·t break point. Äá»ƒ khi chÆ°Æ¡ng trÃ¬nh cháº¡y Ä‘áº¿n Ä‘Ã³ nÃ³ sáº½ dá»«ng.

3.5 XÃ¢y dá»±ng cáº¥u trÃºc thanh ghi cá»§a cÃ¡c ngoáº¡i vi (Struct)

